<!DOCTYPE html>
<html>
<head>
    <title>Master Admin Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css">
    <!-- Cloudinary Widget -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <!-- Crypto JS (Delete ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂Ö‡∂≠‡∑ä‚Äç‡∂∫‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫‡∂∫‡∑í) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>

<!-- Login Screen -->
<div id="loginOverlay" class="login-screen">
    <div class="login-box">
        <h2 style="color:#ff0000; margin-top:0;">üõë ADMIN ONLY</h2>
        <input type="password" id="pass" class="input-field" placeholder="Enter Password">
        <button onclick="login()" class="btn-main">Unlock System</button>
    </div>
</div>

<!-- Admin Dashboard -->
<div class="container" id="adminPanel" style="display:none;">
    <header style="border-radius:8px; margin-bottom:20px;">
        <div class="logo">Control Panel</div>
        <div style="display:flex; gap:10px;">
            <a href="https://janith214.pythonanywhere.com/admin" target="_blank" class="nav-btn" style="background:#0088cc;">ü§ñ Bot</a>
            <a href="index.html" target="_blank" class="nav-btn">üåê Site</a>
        </div>
    </header>

    <!-- Upload Section -->
    <div class="card">
        <h3>1. Upload Video (Cloudinary)</h3>
        <button id="upload_widget" class="btn-main" style="background:#222; border:1px solid #555;">‚òÅ Upload New File</button>
        <div id="result" style="display:none; margin-top:15px;">
            <input type="text" id="videoUrl" class="copy-input" readonly>
            <button onclick="copyLink()" class="nav-btn" style="width:100%; margin-top:5px;">Copy Link</button>
        </div>
    </div>

    <!-- Data Entry Section -->
    <div class="card">
        <h3>2. Add Details (Database)</h3>
        <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSebNoCslhUPfwtjRGYhn34XG82waUlJncXsts4SPxX_XBo3Tg/viewform?usp=dialog" width="100%" height="450" frameborder="0">Loading...</iframe>
    </div>

    <!-- Delete Section (Files & Data) -->
    <div class="card" style="border: 1px solid #ff0000;">
        <h3 style="color:#ff0000;">3. Manage Storage & Data</h3>
        <p style="font-size:12px; color:#aaa;">Clicking Delete will remove the <b>Actual File</b> from Cloudinary AND the <b>List Entry</b>.</p>
        <div id="manageGrid" style="display:flex; flex-direction:column; gap:10px; max-height:400px; overflow-y:auto;">
            <p>Loading Video List...</p>
        </div>
    </div>
</div>

<script>
    
    // --- SETTINGS (FILL ALL THESE CAREFULLY) ---
    const cloudName = "dekjdisyv"; 
    const uploadPreset = "sexmm5";
    const apiKey = "916257114467554"; // Cloudinary Dashboard ‡∂ë‡∂ö‡∑ö ‡∂≠‡∑í‡∂∫‡∑ô‡∂±‡∑Ä‡∑è
    const apiSecret = "IeoretyzB9VzY_ig_Ho3ihnSYBE"; // Cloudinary Dashboard ‡∂ë‡∂ö‡∑ö ‡∂≠‡∑í‡∂∫‡∑ô‡∂±‡∑Ä‡∑è
    
    const sheetCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTDHMCsnKxbAdBApU5e1Jqw65HhPP_ti_TczWjyhMC-emufORz2D6MvWNrVk77KqF7so5OPhIR8YGkz/pub?output=csv";
    const scriptURL = "https://script.google.com/macros/s/AKfycbwqvStp2gdKfQt6yKP6vMWFlkcCPeUCF5xleccTb3UonE8kUtfaxvMCSK_LSq3X1rxE/exec"; // Google Apps Script Web App URL
    const password = "Vicety200511@";
    // --------------------------------------------

    function login() {
        if(document.getElementById('pass').value === password) {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            loadManageList(); 
        } else { alert("Wrong Password!"); }
    }

    // --- UPLOAD LOGIC ---
    var myWidget = cloudinary.createUploadWidget({
        cloudName: cloudName, uploadPreset: uploadPreset,
        sources: ['local', 'url'], resourceType: 'video', folder: 'uploads', theme: "dark"
    }, (error, result) => { 
        if (!error && result && result.event === "success") { 
            document.getElementById('result').style.display = 'block';
            document.getElementById('videoUrl').value = result.info.secure_url;
            alert("Upload Success! Copy Link.");
        }
    });
    document.getElementById("upload_widget").addEventListener("click", function(){ myWidget.open(); }, false);

    function copyLink() {
        var copyText = document.getElementById("videoUrl");
        copyText.select();
        document.execCommand("copy");
    }

    // --- LOAD LIST ---
    async function loadManageList() {
        const list = document.getElementById('manageGrid');
        try {
            const res = await fetch(sheetCSV);
            const text = await res.text();
            const rows = text.split('\n').slice(1).reverse();
            
            list.innerHTML = "";
            
            rows.forEach((row) => {
                const cols = row.split(',');
                if(cols.length < 3) return;
                
                const title = cols[1]?.replace(/"/g, '');
                const url = cols[3]?.replace(/"/g, '').trim();

                if(title && url) {
                    const item = document.createElement('div');
                    item.style = "background:#222; padding:10px; border-radius:5px; display:flex; justify-content:space-between; align-items:center;";
                    item.innerHTML = `
                        <span style="font-size:14px; max-width:70%; overflow:hidden;">${title}</span>
                        <button onclick="fullDelete('${url}', this)" style="background:#cc0000; color:white; border:none; padding:5px 10px; border-radius:3px; cursor:pointer;">DELETE ALL</button>
                    `;
                    list.appendChild(item);
                }
            });
        } catch(e) { list.innerHTML = "Error loading list."; }
    }

    // --- FULL DELETE LOGIC (Cloudinary + Sheet) ---
    async function fullDelete(url, btnElement) {
        if(!confirm("WARNING: This will permanently delete the VIDEO FILE and the DATA entry. Continue?")) return;

        btnElement.innerText = "Deleting File...";
        btnElement.disabled = true;

        // 1. Extract Public ID from URL
        // URL format: .../upload/v12345/folder/video.mp4 -> we need "folder/video"
        let publicId = "";
        try {
            const parts = url.split('/upload/');
            const path = parts[1].split('/');
            path.shift(); // Remove 'v12345' version part
            publicId = path.join('/').replace(/\.[^/.]+$/, ""); // Remove extension (.mp4)
        } catch(e) {
            alert("Error extracting Video ID. Is this a Cloudinary link?");
            btnElement.innerText = "Delete";
            btnElement.disabled = false;
            return;
        }

        // 2. Generate Signature for Cloudinary Delete
        const timestamp = Math.round((new Date()).getTime() / 1000);
        const paramsStr = `public_id=${publicId}&timestamp=${timestamp}${apiSecret}`;
        const signature = CryptoJS.SHA1(paramsStr).toString();

        // 3. Send Delete Request to Cloudinary
        const formData = new FormData();
        formData.append("public_id", publicId);
        formData.append("api_key", apiKey);
        formData.append("timestamp", timestamp);
        formData.append("signature", signature);
        formData.append("resource_type", "video"); // Important for videos

        try {
            const cloudResponse = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/video/destroy`, {
                method: "POST",
                body: formData
            });
            const cloudResult = await cloudResponse.json();

            if(cloudResult.result === "ok" || cloudResult.result === "not found") {
                // 4. If Cloudinary Delete Success, Delete from Sheet
                btnElement.innerText = "Deleting Data...";
                
                const sheetResponse = await fetch(scriptURL + "?del=" + encodeURIComponent(url));
                const sheetResult = await sheetResponse.text();

                if(sheetResult.includes("Deleted")) {
                    alert("‚úÖ Success! Video File & Data Entry deleted.");
                    btnElement.parentElement.remove();
                } else {
                    alert("‚ö†Ô∏è File deleted from Cloud, but Google Sheet delete failed. Please check Script.");
                }

            } else {
                alert("‚ùå Cloudinary Delete Failed: " + JSON.stringify(cloudResult));
                btnElement.innerText = "Delete";
                btnElement.disabled = false;
            }

        } catch(err) {
            console.error(err);
            alert("Network Error.");
            btnElement.innerText = "Delete";
            btnElement.disabled = false;
        }
    }
</script>

</body>
</html>